<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width">
  <title>Pusher-Geo-Tweets</title>
  <script src="https://js.pusher.com/3.1/pusher.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.14.1/moment.min.js"></script>
  <script src='https://api.mapbox.com/mapbox-gl-js/v0.21.0/mapbox-gl.js'></script>
  <script src='/ngeohash.js'></script>
  <link href='https://api.mapbox.com/mapbox-gl-js/v0.21.0/mapbox-gl.css' rel='stylesheet' />
  <style>
    html, body {
      width: 100%;
      margin:0;
    }
    #hash {
      text-align: center;
    }
    #tweets {
      text-align:center;
      margin:10px auto;
      padding:10px;
      border:1px solid #294E80;
      width:500px;
      border-radius: 10px;
    }
    .tweet {
      border-bottom: 1px solid #294E80;
      margin-bottom: 5px;
      clear: both;
    }
    .tweet::before, .tweet::after {
      clear:both;
      content:'';
      display:block;ÃŸ
    }
    #tweets>div:last-of-type {
      display:none;
    }
    #tweets>div:first-of-type {
      display:block !important;
    }

    #map {
      height: 200px;
      width: 500px;
      margin: 0 auto;
    }
  </style>
</head>
<body>
  <h1 id="hash"></h1>
  <div id="map"></div>
  <div id="tweets">
    <div>No tweets yet</div>
  </div>

  <script>
    var pusher = new Pusher('e83407adb89c0c6b183a', {
      cluster: 'eu',
      encrypted: true
    });

    var tweetContainer = document.getElementById('tweets');
    var hash = window.location.search.substring(1) || 'gcpn';
    document.getElementById('hash').innerText = hash;

    function buildTweet(data) {
      var element = document.createElement('div');
      element.classList.add('tweet');
      element.classList.add('show');
      element.innerHTML = `
        <div style="float:left;width:50px;margin-right:5px"><img src="${data.user.profile_image_url_https}"></div>
        <div style="text-align:left">
          <div><b>${data.user.name}</b> <span style="color:#ccc">@${data.user.screen_name}</span> - <small>${moment(data.created_at).format('DD MMM YYYY HH:mm')}</small></div>
          <p style="margin:0">${data.text}</p>
        </div>
      `;
      return element;
    }

    var channel = pusher.subscribe(hash);
    channel.bind('tweet', function(data) {
      tweetContainer.insertBefore(buildTweet(data), tweetContainer.firstChild);
    });
  </script>

  <script>
    var decodedHash = ngeohash.decode(hash);
    mapboxgl.accessToken = 'pk.eyJ1IjoiYXZlcmFnZW1hcmN1cyIsImEiOiJjaXF0cnAzYnkwMDJlaHRuaW1iZnpreWlrIn0.ODKOblfwl3UE0rWzasZsiw';
    var map = new mapboxgl.Map({
        container: 'map',
        style: 'mapbox://styles/mapbox/streets-v9',
        center: [decodedHash.longitude,decodedHash.latitude],
        zoom: 10,
        doubleClickZoom: false
    });

    map.on('dblclick', function(event) {
      var newHash = ngeohash.encode(event.lngLat.lat, event.lngLat.lng, 4);
      if(hash !== newHash) {
        pusher.unsubscribe(hash);
        hash = newHash;
        document.getElementById('hash').innerText = hash;
        pusher.subscribe(hash).bind('tweet', function(data) {
          tweetContainer.insertBefore(buildTweet(data), tweetContainer.firstChild);
        });
        if (history.pushState) {
          var newurl = window.location.protocol + "//" + window.location.host + window.location.pathname + '?' + hash;
          window.history.pushState({path:newurl},'',newurl);
        } else {
          window.location.search = hash;
        }
      }
    });
  </script>
</body>
</html>
